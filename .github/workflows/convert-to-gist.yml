name: Universal Subscription Generator

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Download JSON subscription
        run: |
          curl -L "${{ secrets.SUB_URL }}" -o nodes.json

      - name: Generate Base64 and Clash YAML
        shell: bash
        run: |
          set -euo pipefail

          BASE64_OUT="converted_base64.txt"
          CLASH_OUT="clash_universal.yaml"
          : > "$BASE64_OUT"
          : > "$CLASH_OUT"

          # Clash YAML header
          printf "port: 7890\nsocks-port: 7891\nallow-lan: true\nmode: rule\nlog-level: info\nproxies:\n" >> "$CLASH_OUT"

          v_index=1
          t_index=1

          # 遍历节点
          jq -c '.proxies[]' nodes.json | while read -r node; do
            type=$(jq -r '.type // empty' <<< "$node")
            server=$(jq -r '.server // empty' <<< "$node")
            port=$(jq -r '.port // empty' <<< "$node")
            [[ -z "$type" || -z "$server" || -z "$port" ]] && continue

            network=$(jq -r '.network // "tcp"' <<< "$node")
            path=$(jq -r '.["ws-opts"].path // "/"' <<< "$node")
            host=$(jq -r '.["ws-opts"].headers.Host // .server' <<< "$node")
            sni=$(jq -r '.servername // .server' <<< "$node")
            tls=$(jq -r '.tls // true' <<< "$node")
            fp=$(jq -r '.["client-fingerprint"] // "chrome"' <<< "$node")
            uuid=$(jq -r '.uuid // empty' <<< "$node")
            password=$(jq -r '.password // empty' <<< "$node")

            if [[ "$type" == "vless" ]]; then
              [[ -z "$uuid" ]] && continue
              name=$(printf "BPB-V%02d" "$v_index")
              v_index=$((v_index+1))

              # Base64 URL
              echo "vless://${uuid}@${server}:${port}?type=${network}&security=tls&encryption=none&path=${path}&host=${host}&sni=${sni}&fp=${fp}&allowInsecure=1#${name}" >> "$BASE64_OUT"

              # Clash YAML
              printf "  - name: \"%s\"\n    type: vless\n    server: %s\n    port: %s\n    uuid: %s\n    tls: true\n    skip-cert-verify: true\n    network: %s\n    ws-opts:\n      path: \"%s\"\n      headers:\n        Host: %s\n    servername: %s\n" \
              "$name" "$server" "$port" "$uuid" "$network" "$path" "$host" "$sni" >> "$CLASH_OUT"

            elif [[ "$type" == "trojan" ]]; then
              [[ -z "$password" ]] && continue
              name=$(printf "BPB-T%02d" "$t_index")
              t_index=$((t_index+1))

              # Base64 URL
              echo "trojan://${password}@${server}:${port}?type=${network}&security=tls&path=${path}&host=${host}&sni=${sni}&allowInsecure=1#${name}" >> "$BASE64_OUT"

              # Clash YAML
              printf "  - name: \"%s\"\n    type: trojan\n    server: %s\n    port: %s\n    password: %s\n    tls: true\n    skip-cert-verify: true\n    network: %s\n    ws-opts:\n      path: \"%s\"\n      headers:\n        Host: %s\n    servername: %s\n" \
              "$name" "$server" "$port" "$password" "$network" "$path" "$host" "$sni" >> "$CLASH_OUT"

            fi
          done

          # Base64 encode for subscription
          base64 -w 0 "$BASE64_OUT" > final_base64.txt

      - name: Upload to Gist
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GIST_TOKEN }}
          script: |
            const fs = require('fs');
            const base64_content = fs.readFileSync('final_base64.txt', 'utf8');
            const clash_content = fs.readFileSync('clash_universal.yaml', 'utf8');

            await github.rest.gists.update({
              gist_id: process.env.GIST_ID,
              files: {
                'converted_base64.txt': { content: base64_content },
                'clash_universal.yaml': { content: clash_content }
              }
            });
        env:
          GIST_ID: ${{ secrets.GIST_ID }}

      - name: Show subscription URLs
        run: |
          echo "✅ Base64 URL:"
          echo "https://gist.githubusercontent.com/${{ github.actor }}/${{ secrets.GIST_ID }}/raw/converted_base64.txt"
          echo "✅ Clash YAML URL:"
          echo "https://gist.githubusercontent.com/${{ github.actor }}/${{ secrets.GIST_ID }}/raw/clash_universal.yaml"
