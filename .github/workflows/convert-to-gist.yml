name: Convert and Push to Gist

on:
  schedule:
    - cron: "0 */6 * * *"  # 每6小时
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download subscription
        env:
          SUB_URL: ${{ secrets.SUB_URL }}
        run: |
          curl -fsSL "$SUB_URL" -o raw.txt
          echo "Downloaded subscription:"
          head raw.txt || true

      - name: Detect if BASE64
        id: detect
        run: |
          if base64 -d raw.txt >/dev/null 2>&1; then
            echo "base64=true" >> $GITHUB_OUTPUT
          else
            echo "base64=false" >> $GITHUB_OUTPUT
          fi

      - name: Decode if BASE64
        if: steps.detect.outputs.base64 == 'true'
        run: |
          base64 -d raw.txt > decoded.txt
          mv decoded.txt merged.txt

      - name: Use raw text directly if NOT base64
        if: steps.detect.outputs.base64 == 'false'
        run: |
          cp raw.txt merged.txt

      - name: Convert nodes into per-line URL and re-base64
        run: |
          echo "Processing nodes..."
          # 去除空行
          sed -i '/^\s*$/d' merged.txt

          # 输出每行格式整理（不改变协议）
          cat merged.txt | while read line; do
            echo "$line"
          done > url-list.txt

          echo "--- URL final format preview ---"
          head url-list.txt || true

          # 重新 base64
          base64 -w 0 url-list.txt > final-base64.txt

      - name: Upload to Gist
        uses: actions/github-script@v7
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.GIST_ID }}
        with:
          script: |
            const fs = require('fs');
            const content = fs.readFileSync('final-base64.txt', 'utf8');

            const res = await github.rest.gists.update({
              gist_id: process.env.GIST_ID,
              files: {
                "subscription.txt": {
                  content: content
                }
              }
            });

            console.log("Updated Gist:");
            console.log(res.data.html_url);
