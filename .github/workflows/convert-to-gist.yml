name: Generate Universal Subscription

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Download JSON subscription
        run: |
          curl -L "${{ secrets.SUB_URL }}" -o nodes.json

      - name: Generate Base64 and Clash YAML
        shell: bash
        run: |
          set -euo pipefail

          BASE64_OUT="converted_base64.txt"
          CLASH_OUT="clash_universal.yaml"
          : > "$BASE64_OUT"
          : > "$CLASH_OUT"

          # Clash YAML header
          cat <<EOF >> "$CLASH_OUT"
port: 7890
socks-port: 7891
allow-lan: true
mode: rule
log-level: info
proxies:
EOF

          v_index=1
          t_index=1

          # 遍历节点
          jq -c '.proxies[]' nodes.json | while read -r node; do
            type=$(jq -r '.type // empty' <<< "$node")
            server=$(jq -r '.server // empty' <<< "$node")
            port=$(jq -r '.port // empty' <<< "$node")
            [[ -z "$type" || -z "$server" || -z "$port" ]] && continue

            network=$(jq -r '.network // "tcp"' <<< "$node")
            path=$(jq -r '.path // "/"' <<< "$node")
            host=$(jq -r '.host // empty' <<< "$node")
            sni=$(jq -r '.sni // empty' <<< "$node")
            tls=$(jq -r '.tls // true' <<< "$node")  # 默认 TLS

            if [[ "$type" == "vless" ]]; then
              uuid=$(jq -r '.uuid // empty' <<< "$node")
              [[ -z "$uuid" ]] && continue
              name=$(printf "BPB-V%02d" "$v_index")
              v_index=$((v_index+1))

              # Base64 URL
              echo "vless://${uuid}@${server}:${port}?type=${network}&security=tls&encryption=none&path=${path}&host=${host}&sni=${sni}#${name}" >> "$BASE64_OUT"

              # Clash YAML
              cat <<EOF2 >> "$CLASH_OUT"
  - name: "${name}"
    type: vless
    server: ${server}
    port: ${port}
    uuid: ${uuid}
    tls: true
    skip-cert-verify: true
    network: ${network}
    ws-opts:
      path: "${path}"
      headers:
        Host: ${host}
    servername: ${sni}
EOF2

            elif [[ "$type" == "trojan" ]]; then
              password=$(jq -r '.password // empty' <<< "$node")
              [[ -z "$password" ]] && continue
              name=$(printf "BPB-T%02d" "$t_index")
              t_index=$((t_index+1))

              # Base64 URL
              echo "trojan://${password}@${server}:${port}?type=${network}&security=tls&path=${path}&host=${host}&sni=${sni}#${name}" >> "$BASE64_OUT"

              # Clash YAML
              cat <<EOF2 >> "$CLASH_OUT"
  - name: "${name}"
    type: trojan
    server: ${server}
    port: ${port}
    password: ${password}
    tls: true
    skip-cert-verify: true
    network: ${network}
    ws-opts:
      path: "${path}"
      headers:
        Host: ${host}
    servername: ${sni}
EOF2
            fi
          done

      - name: Upload to Gist
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GIST_TOKEN }}
          script: |
            const fs = require('fs');
            const content_base64 = fs.readFileSync("converted_base64.txt", "utf8");
            const content_yaml = fs.readFileSync("clash_universal.yaml", "utf8");
            await github.rest.gists.update({
              gist_id: process.env.GIST_ID,
              files: {
                "converted_base64.txt": { content: content_base64 },
                "clash_universal.yaml": { content: content_yaml }
              }
            });
        env:
          GIST_ID: ${{ secrets.GIST_ID }}

      - name: Show subscription URLs
        run: |
          echo "✅ Base64 URL:"
          echo "https://gist.githubusercontent.com/${{ github.actor }}/${{ secrets.GIST_ID }}/raw/converted_base64.txt"
          echo "✅ Clash YAML URL:"
          echo "https://gist.githubusercontent.com/${{ github.actor }}/${{ secrets.GIST_ID }}/raw/clash_universal.yaml"
