name: Mihomo Config → Base64 Subscription & Gist

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Download mihomo config (raw.json)
        run: |
          curl -L "${{ secrets.SUB_URL }}" -o raw.json
          echo "Downloaded raw.json"
          jq '.proxies | length' raw.json

      #################################################
      # 1️⃣ mihomo proxies → URL → Base64
      #################################################
      - name: Convert proxies to Base64 subscription
        run: |
          : > urls.txt

          jq -c '.proxies[]' raw.json | while read -r p; do
            type=$(echo "$p" | jq -r '.type')
            name=$(echo "$p" | jq -r '.name')

            server=$(echo "$p" | jq -r '.server // empty')
            port=$(echo "$p" | jq -r '.port // empty')
            network=$(echo "$p" | jq -r '.network // "tcp"')
            sni=$(echo "$p" | jq -r '.servername // empty')

            [ -z "$server" ] && continue
            [ -z "$port" ] && continue

            case "$type" in
              vless)
                uuid=$(echo "$p" | jq -r '.uuid // empty')
                [ -z "$uuid" ] && continue

                path=$(echo "$p" | jq -r '.["ws-opts"].path // "/"')
                host=$(echo "$p" | jq -r '.["ws-opts"].headers.Host // empty')

                url="vless://${uuid}@${server}:${port}?type=${network}&path=${path}"
                [ -n "$host" ] && url="${url}&host=${host}"
                [ -n "$sni" ] && url="${url}&sni=${sni}"
                ;;
              vmess)
                vmess_json=$(echo "$p" | jq -c '{
                  v: "2",
                  ps: .name,
                  add: .server,
                  port: (.port | tostring),
                  id: .uuid,
                  aid: (.alterId // 0),
                  net: .network,
                  type: "none",
                  host: (.["ws-opts"].headers.Host // ""),
                  path: (.["ws-opts"].path // "/"),
                  tls: (if .tls then "tls" else "" end)
                }')
                url="vmess://$(echo -n "$vmess_json" | base64 -w0)"
                ;;
              trojan)
                password=$(echo "$p" | jq -r '.password // empty')
                [ -z "$password" ] && continue

                path=$(echo "$p" | jq -r '.["ws-opts"].path // "/"')
                host=$(echo "$p" | jq -r '.["ws-opts"].headers.Host // empty')

                url="trojan://${password}@${server}:${port}?type=${network}&path=${path}"
                [ -n "$host" ] && url="${url}&host=${host}"
                [ -n "$sni" ] && url="${url}&sni=${sni}"
                ;;
              *)
                continue
                ;;
            esac

            echo "${url}#${name}" >> urls.txt
          done

          base64 urls.txt | tr -d '\n' > converted_base64.txt

      #################################################
      # 2️⃣ 同一 Gist，多文件上传
      #################################################
      - name: Upload Base64 & Mihomo config to Gist
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GIST_TOKEN }}
          script: |
            const fs = require("fs");

            await github.rest.gists.update({
              gist_id: process.env.GIST_ID,
              files: {
                "converted_base64.txt": {
                  content: fs.readFileSync("converted_base64.txt", "utf8")
                },
                "mihomo.yaml": {
                  content: fs.readFileSync("raw.json", "utf8")
                }
              }
            });
        env:
          GIST_ID: ${{ secrets.GIST_ID }}

      - name: Show Gist URLs
        run: |
          echo "✅ Gist Page:"
          echo "https://gist.github.com/${{ github.actor }}/${{ secrets.GIST_ID }}"
          echo
          echo "✅ Base64 Subscription:"
          echo "https://gist.githubusercontent.com/${{ github.actor }}/${{ secrets.GIST_ID }}/raw/converted_base64.txt"
          echo
          echo "✅ Mihomo Config:"
          echo "https://gist.githubusercontent.com/${{ github.actor }}/${{ secrets.GIST_ID }}/raw/mihomo.yaml"
