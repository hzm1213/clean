name: Convert JSON Subscription to Gist

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq python3

      - name: Download subscription
        run: |
          curl -sL "${{ secrets.SUB_URL }}" -o raw.json
          echo "Preview raw.json:"
          head -n 20 raw.json

      - name: Build URL list (auto-detect vless/trojan/vmess/ss)
        run: |
          set -e
          : > urls.txt

          urlencode() {
            python3 - <<PY "$1"
import urllib.parse, sys
print(urllib.parse.quote(sys.argv[1], safe=''))
PY
          }

          jq -c '.[]' raw.json | while read -r item; do
            remarks=$(echo "$item" | jq -r '.remarks // empty')
            remark_enc=$(urlencode "$remarks")

            echo "$item" | jq -c '.outbounds[]? | select(.tag=="proxy")' | while read -r ob; do
              proto=$(echo "$ob" | jq -r '.protocol // empty')
              host=$(echo "$ob" | jq -r '.settings.address // empty')
              port=$(echo "$ob" | jq -r '.settings.port // empty')
              network=$(echo "$ob" | jq -r '.streamSettings.network // "tcp"')
              tls=$(echo "$ob" | jq -r '.streamSettings.security // empty')
              sni=$(echo "$ob" | jq -r '.streamSettings.tlsSettings.serverName // empty')
              ws_host=$(echo "$ob" | jq -r '.streamSettings.wsSettings.host // empty')
              ws_path=$(echo "$ob" | jq -r '.streamSettings.wsSettings.path // "/"')

              case "$proto" in
                vless)
                  uuid=$(echo "$ob" | jq -r '.settings.id')
                  url="vless://${uuid}@${host}:${port}?type=${network}&path=$(urlencode "$ws_path")"
                  [ -n "$ws_host" ] && url="${url}&host=$(urlencode "$ws_host")"
                  [ "$tls" = "tls" ] && url="${url}&security=tls"
                  [ -n "$sni" ] && url="${url}&sni=$(urlencode "$sni")"
                  echo "${url}#${remark_enc}" >> urls.txt
                ;;

                trojan)
                  pass=$(echo "$ob" | jq -r '.settings.password // .settings.pass // empty')
                  url="trojan://${pass}@${host}:${port}"
                  params=""
                  [ "$tls" = "tls" ] && params="security=tls"
                  [ -n "$sni" ] && params="${params}${params:+&}sni=$(urlencode "$sni")"
                  [ -n "$params" ] && url="${url}?${params}"
                  echo "${url}#${remark_enc}" >> urls.txt
                ;;

                vmess)
                  vmjson=$(echo "$ob" | jq -c '{v:"2",ps:env.REM,add:.settings.address,port:(.settings.port|tostring),id:.settings.id,aid:"0",net:.streamSettings.network,type:"none",host:.streamSettings.wsSettings.host,path:.streamSettings.wsSettings.path,tls:.streamSettings.security}' --arg REM "$remarks")
                  b64=$(echo -n "$vmjson" | base64 -w 0)
                  echo "vmess://${b64}#${remark_enc}" >> urls.txt
                ;;

                ss)
                  method=$(echo "$ob" | jq -r '.settings.method')
                  passwd=$(echo "$ob" | jq -r '.settings.password')
                  auth=$(printf "%s:%s" "$method" "$passwd" | base64 -w 0)
                  echo "ss://${auth}@${host}:${port}#${remark_enc}" >> urls.txt
                ;;

              esac
            done
          done

      - name: Sort + dedupe URL list
        run: |
          grep -v '^$' urls.txt | sort -u > urls.clean
          mv urls.clean urls.txt
          echo "Total lines: $(wc -l < urls.txt)"

      - name: Encode to Base64 subscription
        run: |
          base64 -w 0 urls.txt > final.txt

      - name: Upload to Gist
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GIST_TOKEN }}
          script: |
            const fs = require("fs");
            const base64 = fs.readFileSync("final.txt", "utf8");
            const urls = fs.readFileSync("urls.txt", "utf8");

            await github.rest.gists.update({
              gist_id: process.env.GID,
              files: {
                "subscription_base64.txt": { content: base64 },
                "subscription_urls.txt": { content: urls }
              }
            });
        env:
          GID: ${{ secrets.GIST_ID }}

      - name: Show Gist URL
        run: |
          echo "GIST 页面： https://gist.github.com/${{ github.actor }}/${{ secrets.GIST_ID }}"
          echo "订阅（base64）： https://gist.githubusercontent.com/${{ github.actor }}/${{ secrets.GIST_ID }}/raw/subscription_base64.txt"
          echo "URL 列表： https://gist.githubusercontent.com/${{ github.actor }}/${{ secrets.GIST_ID }}/raw/subscription_urls.txt"
