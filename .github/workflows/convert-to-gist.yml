name: Convert Subscription to Gist

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: sudo apt-get update -y && sudo apt-get install -y jq python3 curl

      - name: Download Subscription JSON
        env:
          SUB_URL: ${{ secrets.SUB_URL }}
        run: |
          echo "Downloading JSON..."
          curl -fsSL "$SUB_URL" -o raw.json
          echo "Downloaded first 200 chars:"
          head -c 200 raw.json || true

      - name: Convert JSON to URLs
        run: |
          cat > convert.py <<'EOF'
import json, base64, urllib.parse

def enc(x): return urllib.parse.quote(x or "")

data = json.load(open("raw.json"))
urls = []

for item in data:
    remarks = item.get("remarks","")
    for o in item.get("outbounds", []):
        if o.get("tag") != "proxy":
            continue
        proto = (o.get("protocol") or "").lower()

        s = o.get("settings",{}) or {}
        st = o.get("streamSettings",{}) or {}
        ws = st.get("wsSettings",{}) or {}

        host = s.get("address","")
        port = s.get("port","")

        # ----- VLESS -----
        if proto == "vless":
            uuid = s.get("id","")
            net = st.get("network","tcp")
            path = ws.get("path","/")
            host_hdr = ws.get("host","")
            tls = st.get("security","")
            sni = st.get("tlsSettings",{}).get("serverName","")

            q = f"type={net}&path={enc(path)}"
            if host_hdr:
                q += f"&host={enc(host_hdr)}"
            if tls == "tls":
                q += "&security=tls"
            if sni:
                q += f"&sni={enc(sni)}"

            urls.append(f"vless://{uuid}@{host}:{port}?{q}#{enc(remarks)}")

        # ----- TROJAN -----
        elif proto == "trojan":
            pwd = s.get("password","")
            tls = st.get("security","")
            sni = st.get("tlsSettings",{}).get("serverName","")

            q = []
            if tls == "tls":
                q.append("security=tls")
            if sni:
                q.append(f"sni={enc(sni)}")
            qp = "?" + "&".join(q) if q else ""

            urls.append(f"trojan://{pwd}@{host}:{port}{qp}#{enc(remarks)}")

        # ----- VMESS -----
        elif proto == "vmess":
            obj = {
                "v": "2",
                "ps": remarks,
                "add": host,
                "port": str(port),
                "id": s.get("id",""),
                "aid": "0",
                "net": st.get("network","tcp"),
                "type": "none",
                "host": ws.get("host",""),
                "path": ws.get("path","/"),
                "tls": st.get("security","")
            }
            raw = json.dumps(obj, separators=(",",":"))
            b64 = base64.b64encode(raw.encode()).decode()
            urls.append(f"vmess://{b64}#{enc(remarks)}")

        # ----- Shadowsocks -----
        elif proto == "ss":
            method = s.get("method","")
            pwd = s.get("password","")
            auth = base64.b64encode(f"{method}:{pwd}".encode()).decode()
            urls.append(f"ss://{auth}@{host}:{port}#{enc(remarks)}")

        else:
            urls.append(f"# unsupported:{proto} {remarks}")

# 去重保持顺序
seen=set()
final=[]
for u in urls:
    if u not in seen:
        final.append(u); seen.add(u)

open("urls.txt","w").write("\n".join(final))
EOF

          python3 convert.py
          echo "Generated:"
          head -n 20 urls.txt || true

      - name: Encode base64
        run: base64 -w 0 urls.txt > sub_base64.txt

      - name: Upload to Gist
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.GIST_ID }}
        run: |
          BODY=$(jq -n \
            --rawfile a urls.txt \
            --rawfile b sub_base64.txt \
            '{files: { "subscription_urls.txt": {content: $a}, "subscription_base64.txt": {content: $b} }}')

          curl -sS -X PATCH \
            -H "Authorization: token $GIST_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d "$BODY" \
            "https://api.github.com/gists/$GIST_ID"

          echo "==== GIST UPDATED ===="
          echo "Gist Page: https://gist.github.com/${{ github.actor }}/${{ secrets.GIST_ID }}"
          echo "Raw URLs:  https://gist.githubusercontent.com/${{ github.actor }}/${{ secrets.GIST_ID }}/raw/subscription_urls.txt"
          echo "Base64:    https://gist.githubusercontent.com/${{ github.actor }}/${{ secrets.GIST_ID }}/raw/subscription_base64.txt"
