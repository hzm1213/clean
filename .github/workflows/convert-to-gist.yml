name: Mihomo JSON ‚Üí Standard Clash YAML

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Download raw mihomo json
        run: |
          curl -L "${{ secrets.SUB_URL }}" -o raw.json
          jq '.proxies | length' raw.json

      #################################################
      # 1Ô∏è‚É£ ÁîüÊàêÊ†áÂáÜ Clash YAML
      #################################################
      - name: Generate standard clash.yaml
        run: |
          {
            echo "mixed-port: 7890"
            echo "allow-lan: true"
            echo "mode: rule"
            echo "log-level: info"
            echo ""
            echo "proxies:"
            jq -c '.proxies[]' raw.json | while read -r p; do
              echo "  - name: \"$(echo "$p" | jq -r '.name')\""
              echo "    type: $(echo "$p" | jq -r '.type')"
              echo "    server: $(echo "$p" | jq -r '.server')"
              echo "    port: $(echo "$p" | jq -r '.port')"

              for k in uuid password cipher udp tls sni servername alpn flow; do
                v=$(echo "$p" | jq -r ".${k} // empty")
                [ -n "$v" ] && echo "    ${k}: ${v}"
              done

              net=$(echo "$p" | jq -r '.network // empty')
              [ -n "$net" ] && echo "    network: ${net}"

              ws_path=$(echo "$p" | jq -r '.["ws-opts"].path // empty')
              ws_host=$(echo "$p" | jq -r '.["ws-opts"].headers.Host // empty')

              if [ -n "$ws_path" ] || [ -n "$ws_host" ]; then
                echo "    ws-opts:"
                [ -n "$ws_path" ] && echo "      path: \"${ws_path}\""
                [ -n "$ws_host" ] && echo "      headers:"
                [ -n "$ws_host" ] && echo "        Host: \"${ws_host}\""
              fi

              grpc_service=$(echo "$p" | jq -r '.["grpc-opts"].["grpc-service-name"] // empty')
              if [ -n "$grpc_service" ]; then
                echo "    grpc-opts:"
                echo "      grpc-service-name: \"${grpc_service}\""
              fi
            done

            echo ""
            echo "proxy-groups:"
            echo "  - name: üöÄ Proxy"
            echo "    type: select"
            echo "    proxies:"
            jq -r '.proxies[].name' raw.json | sed 's/^/      - "/; s/$/"/'

            echo ""
            echo "rules:"
            echo "  - MATCH,üöÄ Proxy"
          } > clash.yaml

      #################################################
      # 2Ô∏è‚É£ ‰∏ä‰º†Âà∞Âêå‰∏Ä Gist
      #################################################
      - name: Upload clash.yaml to Gist
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GIST_TOKEN }}
          script: |
            const fs = require("fs");
            await github.rest.gists.update({
              gist_id: process.env.GIST_ID,
              files: {
                "clash.yaml": {
                  content: fs.readFileSync("clash.yaml", "utf8")
                }
              }
            });
        env:
          GIST_ID: ${{ secrets.GIST_ID }}

      - name: Output
        run: |
          echo "‚úÖ Standard Clash YAML:"
          echo "https://gist.githubusercontent.com/${{ github.actor }}/${{ secrets.GIST_ID }}/raw/clash.yaml"
