name: Convert JSON Subscription to Gist

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Download subscription (from secret)
        run: |
          curl -L "${{ secrets.SUB_URL }}" -o raw.json
          echo "Downloaded raw.json:"
          head -n 5 raw.json

      - name: Extract VLESS nodes from JSON → URL
        run: |
          : > urls.txt
          jq -c '.[]' raw.json | while read -r item; do
            remarks=$(echo "$item" | jq -r '.remarks')
            
            # 找出 outbounds 里的 tag = "proxy"
            outbound=$(echo "$item" | jq -c '.outbounds[] | select(.tag=="proxy")')

            proto=$(echo "$outbound" | jq -r '.protocol')
            server=$(echo "$outbound" | jq -r '.settings.address')
            port=$(echo "$outbound" | jq -r '.settings.port')
            uuid=$(echo "$outbound" | jq -r '.settings.id')
            encryption=$(echo "$outbound" | jq -r '.settings.encryption')

            network=$(echo "$outbound" | jq -r '.streamSettings.network')

            host=$(echo "$outbound" | jq -r '.streamSettings.wsSettings.host // empty')
            path=$(echo "$outbound" | jq -r '.streamSettings.wsSettings.path // "/"')
            tls=$(echo "$outbound" | jq -r '.streamSettings.security')
            sni=$(echo "$outbound" | jq -r '.streamSettings.tlsSettings.serverName // empty')

            # 构造 URL
            url="vless://${uuid}@${server}:${port}?type=${network}&path=${path}"

            [ -n "$host" ] && url="${url}&host=${host}"
            [ "$tls" = "tls" ] && url="${url}&security=tls"
            [ -n "$sni" ] && url="${url}&sni=${sni}"

            echo "${url}#${remarks}" >> urls.txt
          done

      - name: Convert to Base64 subscription
        run: |
          base64 urls.txt | tr -d '\n' > final.txt

      - name: Upload to Gist
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GIST_TOKEN }}
          script: |
            const fs = require('fs');
            const content = fs.readFileSync('final.txt', 'utf8');

            await github.gists.update({
              gist_id: process.env.GIST_ID,
              files: {
                "converted_base64.txt": {
                  content: content
                }
              }
            });

        env:
          GIST_ID: ${{ secrets.GIST_ID }}
