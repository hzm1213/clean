name: Mihomo JSON ‚Üí Base64 Subscription + Standard Clash YAML

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Download raw mihomo json
        run: |
          curl -L "${{ secrets.SUB_URL }}" -o raw.json
          echo "Downloaded raw.json"
          jq '.proxies | length' raw.json

      #################################################
      # 1Ô∏è‚É£ Proxies ‚Üí URL ‚Üí Base64 subscription
      #################################################
      - name: Convert proxies to Base64 subscription
        run: |
          : > urls.txt

          jq -c '.proxies[]' raw.json | while read -r p; do
            type=$(echo "$p" | jq -r '.type')
            name=$(echo "$p" | jq -r '.name')

            server=$(echo "$p" | jq -r '.server // empty')
            port=$(echo "$p" | jq -r '.port // empty')
            network=$(echo "$p" | jq -r '.network // "tcp"')
            sni=$(echo "$p" | jq -r '.servername // empty')

            [ -z "$server" ] && continue
            [ -z "$port" ] && continue

            case "$type" in
              vless)
                uuid=$(echo "$p" | jq -r '.uuid // empty')
                [ -z "$uuid" ] && continue
                path=$(echo "$p" | jq -r '.["ws-opts"].path // "/"')
                host=$(echo "$p" | jq -r '.["ws-opts"].headers.Host // empty')

                url="vless://${uuid}@${server}:${port}?type=${network}&path=${path}"
                [ -n "$host" ] && url="${url}&host=${host}"
                [ -n "$sni" ] && url="${url}&sni=${sni}"
                ;;
              vmess)
                vmess_json=$(echo "$p" | jq -c '{
                  v: "2",
                  ps: .name,
                  add: .server,
                  port: (.port | tostring),
                  id: .uuid,
                  aid: (.alterId // 0),
                  net: .network,
                  type: "none",
                  host: (.["ws-opts"].headers.Host // ""),
                  path: (.["ws-opts"].path // "/"),
                  tls: (if .tls then "tls" else "" end)
                }')
                url="vmess://$(echo -n "$vmess_json" | base64 -w0)"
                ;;
              trojan)
                password=$(echo "$p" | jq -r '.password // empty')
                [ -z "$password" ] && continue
                path=$(echo "$p" | jq -r '.["ws-opts"].path // "/"')
                host=$(echo "$p" | jq -r '.["ws-opts"].headers.Host // empty')

                url="trojan://${password}@${server}:${port}?type=${network}&path=${path}"
                [ -n "$host" ] && url="${url}&host=${host}"
                [ -n "$sni" ] && url="${url}&sni=${sni}"
                ;;
              *)
                continue
                ;;
            esac

            echo "${url}#${name}" >> urls.txt
          done

          base64 urls.txt | tr -d '\n' > converted_base64.txt

      #################################################
      # 2Ô∏è‚É£ Generate standard Clash YAML
      #################################################
      - name: Generate standard clash.yaml
        run: |
          {
            echo "mixed-port: 7890"
            echo "allow-lan: true"
            echo "mode: rule"
            echo "log-level: info"
            echo ""
            echo "proxies:"
            jq -c '.proxies[]' raw.json | while read -r p; do
              echo "  - name: \"$(echo "$p" | jq -r '.name')\""
              echo "    type: $(echo "$p" | jq -r '.type')"
              echo "    server: $(echo "$p" | jq -r '.server')"
              echo "    port: $(echo "$p" | jq -r '.port')"

              for k in uuid password cipher udp tls sni servername alpn flow; do
                v=$(echo "$p" | jq -r ".${k} // empty")
                [ -n "$v" ] && echo "    ${k}: ${v}"
              done

              net=$(echo "$p" | jq -r '.network // empty')
              [ -n "$net" ] && echo "    network: ${net}"

              ws_path=$(echo "$p" | jq -r '.["ws-opts"].path // empty')
              ws_host=$(echo "$p" | jq -r '.["ws-opts"].headers.Host // empty')

              if [ -n "$ws_path" ] || [ -n "$ws_host" ]; then
                echo "    ws-opts:"
                [ -n "$ws_path" ] && echo "      path: \"${ws_path}\""
                [ -n "$ws_host" ] && echo "      headers:"
                [ -n "$ws_host" ] && echo "        Host: \"${ws_host}\""
              fi

              grpc_service=$(echo "$p" | jq -r '.["grpc-opts"].["grpc-service-name"] // empty')
              if [ -n "$grpc_service" ]; then
                echo "    grpc-opts:"
                echo "      grpc-service-name: \"${grpc_service}\""
              fi
            done

            echo ""
            echo "proxy-groups:"
            echo "  - name: üöÄ Proxy"
            echo "    type: select"
            echo "    proxies:"
            jq -r '.proxies[].name' raw.json | sed 's/^/      - "/; s/$/"/'

            echo ""
            echo "rules:"
            echo "  - MATCH,üöÄ Proxy"
          } > clash.yaml

      #################################################
      # 3Ô∏è‚É£ Upload all files to the same Gist
      #################################################
      - name: Upload Base64 & Clash YAML to Gist
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GIST_TOKEN }}
          script: |
            const fs = require("fs");
            await github.rest.gists.update({
              gist_id: process.env.GIST_ID,
              files: {
                "converted_base64.txt": { content: fs.readFileSync("converted_base64.txt", "utf8") },
                "clash.yaml": { content: fs.readFileSync("clash.yaml", "utf8") }
              }
            });
        env:
          GIST_ID: ${{ secrets.GIST_ID }}

      - name: Show Gist URLs
        run: |
          echo "‚úÖ Gist Page:"
          echo "https://gist.github.com/${{ github.actor }}/${{ secrets.GIST_ID }}"
          echo "‚úÖ Base64 Subscription:"
          echo "https://gist.githubusercontent.com/${{ github.actor }}/${{ secrets.GIST_ID }}/raw/converted_base64.txt"
          echo "‚úÖ Standard Clash YAML:"
          echo "https://gist.githubusercontent.com/${{ github.actor }}/${{ secrets.GIST_ID }}/raw/clash.yaml"
