name: Convert Subscription to Gist

on:
  schedule:
    - cron: "0 */6 * * *"   # 每6小时执行一次
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install curl & jq & xxd
        run: |
          sudo apt-get update
          sudo apt-get install -y jq xxd

      - name: Download subscription (from secret)
        run: |
          curl -L "${{ secrets.SUB_URL }}" -o raw.txt

      - name: Decode base64 to raw nodes
        run: |
          decoded=$(cat raw.txt | base64 -d 2>/dev/null || true)
          if [ -z "$decoded" ]; then
            echo "❌ 解码失败，源文件不是 base64？" >&2
            exit 1
          fi
          echo "$decoded" > decoded.txt

      - name: Normalize each line to URL form
        run: |
          : > urls.txt
          while IFS= read -r line; do
            [ -z "$line" ] && continue

            if echo "$line" | grep -qE "^(ss|vmess|vless|trojan)://"; then
              echo "$line" >> urls.txt
            else
              :
            fi

          done < decoded.txt

      - name: Convert URL list to base64 subscription
        run: |
          base64 urls.txt | tr -d '\n' > final.txt

      - name: Upload to Gist
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GIST_TOKEN }}
          script: |
            const fs = require('fs');
            const content = fs.readFileSync('final.txt', 'utf8');

            await github.gists.update({
              gist_id: process.env.GIST_ID,
              files: {
                "conv
