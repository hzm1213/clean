name: Convert JSON Subscription to Gist

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Download subscription (from secret)
        run: |
          curl -L "${{ secrets.SUB_URL }}" -o raw.json
          echo "Downloaded raw.json:"
          head -n 5 raw.json

      - name: Extract proxy nodes from JSON → URL
        run: |
          : > urls.txt
          jq -c '.[]' raw.json | while read -r item; do
            remarks=$(echo "$item" | jq -r '.remarks // "NoName"')
            outbound=$(echo "$item" | jq -c '.outbounds[] | select(.tag=="proxy")')
            proto=$(echo "$outbound" | jq -r '.protocol')

            # 通用字段（分 vnext / servers）
            server=$(echo "$outbound" | jq -r '.settings.vnext[0].address // .settings.servers[0].address // empty')
            port=$(echo "$outbound" | jq -r '.settings.vnext[0].port // .settings.servers[0].port // empty')

            # 空值直接跳过避免 null 节点
            [ -z "$server" ] && echo "❌ Skip missing server: $remarks" && continue
            [ -z "$port" ] && echo "❌ Skip missing port: $remarks" && continue

            network=$(echo "$outbound" | jq -r '.streamSettings.network // "tcp"')
            path=$(echo "$outbound" | jq -r '.streamSettings.wsSettings.path // "/"')
            host=$(echo "$outbound" | jq -r '.streamSettings.wsSettings.host // empty')
            tls=$(echo "$outbound" | jq -r '.streamSettings.security // ""')
            sni=$(echo "$outbound" | jq -r '.streamSettings.tlsSettings.serverName // empty')

            case $proto in
              vless)
                uuid=$(echo "$outbound" | jq -r '.settings.vnext[0].users[0].id // empty')
                url="vless://${uuid}@${server}:${port}?type=${network}&path=${path}"
                [ -n "$host" ] && url="${url}&host=${host}"
                [ "$tls" = "tls" ] && url="${url}&security=tls"
                [ -n "$sni" ] && url="${url}&sni=${sni}"
                ;;
              vmess)
                vmess_json=$(echo "$outbound" | jq -c '{
                  v: "2",
                  ps: "'"$remarks"'",
                  add: (.settings.vnext[0].address // ""),
                  port: (.settings.vnext[0].port // ""),
                  id: (.settings.vnext[0].users[0].id // ""),
                  aid: (.settings.vnext[0].users[0].alterId // 0),
                  net: (.streamSettings.network // ""),
                  type: "none",
                  host: (.streamSettings.wsSettings.host // ""),
                  path: (.streamSettings.wsSettings.path // "/"),
                  tls: (.streamSettings.security // "")
                }')
                url="vmess://$(echo -n "$vmess_json" | base64 -w0)"
                ;;
              trojan)
                password=$(echo "$outbound" | jq -r '.settings.servers[0].password // empty')
                url="trojan://${password}@${server}:${port}?type=${network}&path=${path}"
                [ -n "$host" ] && url="${url}&host=${host}"
                [ "$tls" = "tls" ] && url="${url}&security=tls"
                [ -n "$sni" ] && url="${url}&sni=${sni}"
                ;;
              *)
                echo "⚠️ Unknown protocol $proto, skip"
                continue
                ;;
            esac

            echo "${url}#${remarks}" >> urls.txt
          done

      - name: Convert to Base64 subscription
        run: |
          base64 urls.txt | tr -d '\n' > final.txt

      - name: Upload to Gist
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GIST_TOKEN }}
          script: |
            const fs = require('fs');
            const content = fs.readFileSync('final.txt', 'utf8');

            await github.rest.gists.update({
              gist_id: process.env.GIST_ID,
              files: {
                "converted_base64.txt": { content: content }
              }
            });
        env:
          GIST_ID: ${{ secrets.GIST_ID }}

      - name: Show Gist URL in Logs
        run: |
          echo "✅ Gist Page URL: https://gist.github.com/${{ github.actor }}/${{ secrets.GIST_ID }}"
          echo "✅ Gist Raw URL: https://gist.githubusercontent.com/${{ github.actor }}/${{ secrets.GIST_ID }}/raw/converted_base64.txt"
