name: Convert JSON to Gist

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq python3

      - name: Download subscription
        run: |
          curl -sL "${{ secrets.SUB_URL }}" -o raw.json
          head -n 20 raw.json

      - name: Extract nodes
        run: |
          echo "" > urls.txt

          python3 <<'EOF'
import json, base64, urllib.parse

def enc(x):
    return urllib.parse.quote(x or "")

data = json.load(open("raw.json"))
out = []

for item in data:
    remarks = item.get("remarks","")
    for ob in item.get("outbounds",[]):
        if ob.get("tag")!="proxy":
            continue
        
        proto = ob.get("protocol")
        host = ob["settings"].get("address","")
        port = ob["settings"].get("port","")
        net  = ob.get("streamSettings",{}).get("network","tcp")
        tls  = ob.get("streamSettings",{}).get("security","")
        sni  = ob.get("streamSettings",{}).get("tlsSettings",{}).get("serverName","")
        ws   = ob.get("streamSettings",{}).get("wsSettings",{})
        ws_host = ws.get("host","")
        ws_path = ws.get("path","/")

        # ------- vless -------
        if proto=="vless":
            uuid = ob["settings"].get("id","")
            q = f"type={net}&path={enc(ws_path)}"
            if ws_host:
                q += f"&host={enc(ws_host)}"
            if tls=="tls":
                q += "&security=tls"
            if sni:
                q += f"&sni={enc(sni)}"
            out.append(f"vless://{uuid}@{host}:{port}?{q}#{enc(remarks)}")

        # ------- trojan -------
        elif proto=="trojan":
            pw = ob["settings"].get("password","")
            q = []
            if tls=="tls":
                q.append("security=tls")
            if sni:
                q.append(f"sni={enc(sni)}")
            qs = "&".join(q)
            url = f"trojan://{pw}@{host}:{port}"
            if qs:
                url += f"?{qs}"
            out.append(f"{url}#{enc(remarks)}")

        # ------- vmess -------
        elif proto=="vmess":
            body = {
                "v":"2",
                "ps":remarks,
                "add":host,
                "port":str(port),
                "id":ob["settings"].get("id",""),
                "aid":"0",
                "net":net,
                "type":"none",
                "host":ws_host,
                "path":ws_path,
                "tls":tls
            }
            raw = json.dumps(body, separators=(",",":"))
            b64 = base64.b64encode(raw.encode()).decode()
            out.append(f"vmess://{b64}#{enc(remarks)}")

        # ------- ss -------
        elif proto=="ss":
            method = ob["settings"].get("method","")
            passwd = ob["settings"].get("password","")
            auth = base64.b64encode(f"{method}:{passwd}".encode()).decode()
            out.append(f"ss://{auth}@{host}:{port}#{enc(remarks)}")

# 去重 & 排序
out = sorted(set(out))
open("urls.txt","w").write("\n".join(out))
EOF

      - name: Encode to base64
        run: |
          base64 -w 0 urls.txt > sub.txt

      - name: Update Gist
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GIST_TOKEN }}
          script: |
            const fs = require("fs");
            const b64 = fs.readFileSync("sub.txt","utf8");
            const raw = fs.readFileSync("urls.txt","utf8");

            await github.rest.gists.update({
              gist_id: process.env.GID,
              files: {
                "subscription_base64.txt": { content: b64 },
                "subscription_urls.txt": { content: raw }
              }
            });
        env:
          GID: ${{ secrets.GIST_ID }}

      - name: Show links
        run: |
          echo "Gist 页面： https://gist.github.com/${{ github.actor }}/${{ secrets.GIST_ID }}"
          echo "Base64 订阅： https://gist.githubusercontent.com/${{ github.actor }}/${{ secrets.GIST_ID }}/raw/subscription_base64.txt"
          echo "URL 列表： https://gist.githubusercontent.com/${{ github.actor }}/${{ secrets.GIST_ID }}/raw/subscription_urls.txt"
